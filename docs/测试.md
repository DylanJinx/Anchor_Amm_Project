AMM 合约测试用例文档

📖 概述

本文档详细描述了 AMM 合约所需的完整测试用例，确保合约的功能性、安全
性和鲁棒性。

🧪 测试文件结构

tests/
├── create-amm.ts ✅ 已完成
├── create-pool.ts ✅ 已完成
├── deposit-liquidity.ts ❌ 待实现
├── swap.ts ❌ 待实现
├── withdraw-liquidity.ts ❌ 待实现
└── utils.ts ✅ 已完成

---

1️⃣ deposit-liquidity.ts

🎯 核心功能测试

✅ 正常流程测试

- 初始流动性添加
  - 第一次向空池子添加流动性
  - 验证 LP 代币正确铸造 (amount = sqrt(amount_a \* amount_b) -
    MINIMUM_LIQUIDITY)
  - 验证最小流动性被锁定
- 后续流动性添加
  - 按现有比例添加流动性
  - 验证比例自动调整逻辑
  - 验证 LP 代币按比例铸造

❌ 错误情况测试

- 余额不足
  - 用户代币 A 余额不足
  - 用户代币 B 余额不足
  - 验证自动调整为实际余额
- 最小流动性检查
  - 初始流动性小于 MINIMUM_LIQUIDITY 时拒绝
  - 验证 DepositTooSmall 错误

🔍 边界条件测试

- 极小数量添加
- 极大数量添加
- 不同小数位代币组合

---

2️⃣ swap.ts

🎯 核心功能测试

✅ 交换逻辑测试

- A→B 交换 (swap_a = true)
  - 验证输入输出数量计算
  - 验证手续费正确扣除
  - 验证 AMM 不变量 k=x\*y
- B→A 交换 (swap_a = false)
  - 验证反向交换逻辑
  - 验证数学公式一致性

🛡️ 安全性测试

- 滑点保护
  - output < min_output_amount 时拒绝
  - 验证 OutputTooSmall 错误
- 不变量验证
  - 交换后 k' >= k
  - k 值异常时验证 InvariantViolated 错误
- 余额检查
  - 用户余额不足时自动调整输入

📊 数学准确性测试

- 手续费计算
  - 不同费率下的计算准确性
  - 验证 taxed_input = input - input \* fee / 10000
- 价格影响测试
  - 大额交换的价格滑点
  - 小额交换的精度保持

---

3️⃣ withdraw-liquidity.ts

🎯 核心功能测试

✅ 正常提取测试

- 完整提取
  - 提取所有 LP 代币
  - 验证代币 A、B 按比例返还
  - 验证 LP 代币正确销毁
- 部分提取
  - 提取部分 LP 代币
  - 验证剩余流动性不受影响

🔍 计算准确性测试

- 提取数量计算
  - amount_a = (lp_amount \* pool_a) / (total_supply +
    MINIMUM_LIQUIDITY)
  - amount_b = (lp_amount \* pool_b) / (total_supply +
    MINIMUM_LIQUIDITY)
  - 验证 floor()向下取整逻辑

❌ 错误情况测试

- 余额不足
  - LP 代币余额不足时拒绝
  - 池子代币不足时的处理

🛡️ 最小流动性保护

- 验证 MINIMUM_LIQUIDITY 永远锁定
- 确保池子不能完全清空

---

4️⃣ 集成测试 (完整流程)

🔄 完整 AMM 生命周期测试

describe("Complete AMM Lifecycle", () => {
it("Full workflow", async () => {
// 1. 创建 AMM
// 2. 创建 Pool  
 // 3. 添加初始流动性
// 4. 执行多次交换
// 5. 添加更多流动性
// 6. 部分提取流动性
// 7. 验证最终状态一致性
});
});

📈 多用户交互测试

- 多个流动性提供者
- 多个交易者同时操作
- 前沿场景 (frontrunning) 防护

---

5️⃣ 性能和极限测试

⚡ 极限数值测试

- 接近 u64 最大值的数量
- 接近零的最小数量
- 高精度计算准确性

🔢 数学验证测试

- 不变量保持性
  - 多次操作后 k 值趋势
  - 舍入误差累积验证
- 手续费累积
  - 长期运行后的手续费分配
  - LP 提供者收益验证

---

📝 测试实施优先级

🚨 高优先级 (必须实现)

1. deposit-liquidity.ts - 核心流动性功能
2. swap.ts - 核心交换功能
3. withdraw-liquidity.ts - 完整生命周期

🔸 中优先级 (建议实现)

4. 集成测试 - 端到端验证
5. 多用户测试 - 并发安全性

🔹 低优先级 (可选实现)

6. 性能测试 - 极限情况
7. 数学验证测试 - 长期稳定性

---

🛠️ 测试工具和断言

常用断言模式

// 数值比较
expect(actualValue).to.equal(expectedValue);
expect(actualValue).to.be.closeTo(expectedValue, tolerance);

// 账户状态验证
const account = await program.account.pool.fetch(poolPda);
expect(account.mintA.toString()).to.equal(mintA.toString());

// 错误处理验证
await expectRevert(someFailingOperation());

// 余额变化验证
const balanceBefore = await getTokenBalance();
// ... 执行操作
const balanceAfter = await getTokenBalance();
expect(balanceAfter - balanceBefore).to.equal(expectedChange);

这份测试文档确保了 AMM 合约的全面验证，涵盖了功能性、安全性和鲁棒性
的各个方面。建议按优先级逐步实施测试用例。
